---
- hosts: localhost
  gather_facts: yes
  vars:
    network_name: 'ovs-network'
    bridge_name: 'ovs-br1'
  sudo: yes

  tasks:
  - name: Install libvirt packages if necessary
    apt:
      name:
      - qemu-kvm
      - libvirt-bin
      - python-libvirt
      - python-lxml
      - virt-manager
      - virt-viewer
      - virtinst
      state: present
    when: ansible_os_family == "Debian"

  - name: Installing OVS
    apt:
      name:
      - openvswitch-switch
      state: present

  - name: Creating OVS bridge
    openvswitch_bridge:
      bridge: ovs-br1
      state: present

  - name: Define the network
    virt_net:
      command: define
      name: '{{ network_name }}'
      xml: '{{ lookup("template", "templates/ovs-network.xml.j2") }}'
      state: present

  - name: Create the network
    virt_net:
      command: create
      autostart: yes
      name: '{{ network_name }}'
    ignore_errors: true

  - name: Start the network
    virt_net:
      command: start
      name: '{{ network_name }}'

  - name: Show networks
    virt_net:
      command: list_nets
    register: out 
  - debug: var=out
